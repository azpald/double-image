<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Canvas Cover + Grayscale</title>
<style>
  body {
    font-family: sans-serif;
    padding: 20px;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    max-width: 100%;
  }

  .column {
    display: flex;
    flex-direction: column;
  }

  canvas {
    border: 1px solid #ccc;
    margin-top: 10px;
    max-width: 100%;
  }

  #ir_canvas_result {
    background-color: black;
  }
  #ir_canvas_result:hover {
    background-color: white;
  }
</style>
</head>
<body>

<div class="grid">
  <div class="column">
    <input type="file" accept="image/*" id="ir_input_img1" autocomplete="off"/>
    <textarea style="display: none;" id="ir_color_img1">{"min": 0, "max": 127, "base": [0, 0, 0]}</textarea>
    <canvas id="ir_canvas_img1"></canvas>
  </div>

  <div class="column">
    <input type="file" accept="image/*" id="ir_input_img2" autocomplete="off"/>
    <canvas id="ir_canvas_img2"></canvas>
    <textarea style="display: none;" id="ir_color_img2">{"min": 128, "max": 255, "base": [255, 255, 255]}</textarea>
  </div>
</div>

<canvas id="ir_canvas_result"></canvas>

<script>
function jsonDecode(str) {
  if (!str) return null;
  try {
    const parsed = JSON.parse(str);
    return parsed;
  } catch (error) {
    return null;
  }
}

const imageResources = {};

for (const i of ["img1", "img2", "result"]) {
    imageResources[i] ??= {};
    imageResources[i].input  = document.getElementById(`ir_input_${i}`) ?? null;
    imageResources[i].canvas = document.getElementById(`ir_canvas_${i}`);
    imageResources[i].ctx = imageResources[i].canvas.getContext("2d");
    imageResources[i].configColor = jsonDecode(document.getElementById(`ir_color_${i}`)?.value);
}

// 2:1 canvas
function resizeCanvas(canvas, width = 800) {
  canvas.width  = width;
  canvas.height = width / 4 * 3;
}

for (const i of Object.keys(imageResources)) {
  const res = imageResources[i];

  const canvas = res.canvas;
  const input  = res.input;
  const ctx    = res.ctx;

  resizeCanvas(canvas);

  input && input.addEventListener("change", () => {
    const file = input.files[0];
    if (!file) return;
  
    const img = new Image();
    img.onload = () => drawCoverGrayscale(img, res);
    img.src = URL.createObjectURL(file);
    setTimeout(updateResult, 500, imageResources);
  });
}


function drawCoverGrayscale(img, res) {
  const {canvas, ctx} = res;

  const cw = canvas.width;
  const ch = canvas.height;

  const ir = img.width / img.height;
  const cr = cw / ch;

  let sx, sy, sw, sh;

  if (ir > cr) {
    sh = img.height;
    sw = img.height * cr;
    sx = (img.width - sw) / 2;
    sy = 0;
  } else {
    sw = img.width;
    sh = img.width / cr;
    sx = 0;
    sy = (img.height - sh) / 2;
  }

  ctx.clearRect(0, 0, cw, ch);
  ctx.drawImage(img, sx, sy, sw, sh, 0, 0, cw, ch);

  applyGrayscale127(res);
}

function applyGrayscale127(res) {
  const {canvas, ctx, configColor = {min: 0, max: 255}} = res;

  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;

  for (let i = 0; i < data.length; i += 4) {
    const r = data[i];
    const g = data[i + 1];
    const b = data[i + 2];
    const a = data[i + 3];

    // Grayscale
    let gray = 0.299 * r + 0.587 * g + 0.114 * b;
    gray *= a / 255;

    // Map 0–255 → color range
    const colorRange = configColor.max - configColor.min;
    gray = configColor.min + Math.round(gray * colorRange / 255);

    data[i]     = gray;
    data[i + 1] = gray;
    data[i + 2] = gray;
    data[i + 3] = 255;
  }

  ctx.putImageData(imageData, 0, 0);
}

function updateResult(imageResources) {
  const res1 = imageResources["img1"];
  const canvas1 = res1.canvas, ctx1 = res1.ctx, configColor1 = res1.configColor;
  const imageData1 = ctx1.getImageData(0, 0, canvas1.width, canvas1.height);
  const data1 = imageData1.data;
  const base1 = Math.max(...(configColor1.base ?? [0])) / 255;

  const res2 = imageResources["img2"];
  const canvas2 = res2.canvas, ctx2 = res2.ctx, configColor2 = res2.configColor;
  const imageData2 = ctx2.getImageData(0, 0, canvas2.width, canvas2.height);
  const data2 = imageData2.data;
  const base2 = Math.max(...(configColor2.base ?? [0])) / 255;

  const resR = imageResources["result"];
  const canvasR = resR.canvas, ctxR = resR.ctx, configColorR = resR.configColor;
  const imageDataR = ctxR.getImageData(0, 0, canvasR.width, canvasR.height);
  const dataR = imageDataR.data;
  console.log("dataR", dataR.length);

  for (let i = 0; i < dataR.length; i += 4) {
    let d1 = data1[i] / 255; // take from red
    let d2 = data2[i] / 255; // take from red

    d1 = Math.min(1, Math.max(0, d1));
    d2 = Math.min(1, Math.max(0, d2));

    const alpha = Math.round((1 - (d1 - d2) / (base1 - base2)) * 255 );
    const value = Math.round((base1 + (d1 - base1) / alpha * 255) * 255);

    dataR[i]     = value;
    dataR[i + 1] = value;
    dataR[i + 2] = value;
    dataR[i + 3] = alpha;

    if (i === 0) {
      console.log("red1", data1[i]);
      console.log("red2", data2[i]);
      console.log("d1", d1);
      console.log("d2", d2);
      console.log("base1", base1);
      console.log("base2", base2);
      console.log("alpha", alpha);
      console.log("value", value);
      console.log(dataR.slice(0, 4));
    }
  }

  ctxR.putImageData(imageDataR, 0, 0);

}

</script>

</body>
</html>
